@model IEnumerable<SistemadePasteleria.Models.Pedido>

@{
    ViewData["Title"] = "Pedidos";
}

<div class="card shadow-sm p-4" style="background-color: rgba(255, 255, 255, 0.9); border-radius: 12px;">
    <h2 class="mb-4 text-center" style="color: #6c757d;">
        <i class="bi bi-receipt-cutoff me-2"></i> Lista de Pedidos
    </h2>

    <!-- 🔍 Barra de búsqueda -->
    <form asp-action="Index" method="get" class="mb-4" role="search">
        <div class="input-group">
            <input type="text"
                   name="buscar"
                   value="@(ViewData["buscar"] as string)"
                   class="form-control"
                   placeholder="Buscar por cliente, usuario o estado"
                   style="border-radius: 8px 0 0 8px;">
            <button type="submit"
                    class="btn"
                    style="background-color: #6c757d; color: white; border-radius: 0 8px 8px 0;">
                🔍 Buscar
            </button>
        </div>
    </form>

    <!-- Botón Crear -->
    <a asp-action="Create"
       class="btn mb-3"
       style="background-color: #adb5bd; color: white; border-radius: 8px;">
        ➕ Nuevo Pedido
    </a>

    <!-- Tabla -->
    <table class="table table-hover table-bordered" style="background-color: white; border-radius: 8px; overflow: hidden;">
        <thead style="background-color: #e9ecef; color: #6c757d;">
            <tr>
                <th>Cliente</th>
                <th>Usuario</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Estado</th>
                <th class="text-center">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td class="align-middle">@item.Cliente.Nombre</td>
                    <td class="align-middle">@item.Usuario.Nombre</td>
                    <td class="align-middle">@item.Fecha.ToString("dd/MM/yyyy")</td>
                    <td class="align-middle">@item.Total.ToString("C")</td>
                    <td class="align-middle">@item.Estado</td>
                    <td class="align-middle text-center">
                        <a asp-action="Edit" asp-route-id="@item.Id"
                           class="btn btn-sm"
                           style="background-color: #dee2e6; color: #6c757d; border-radius: 6px;">
                            <i class="bi bi-pencil"></i> Editar
                        </a>

                        <a asp-action="Details" asp-route-id="@item.Id"
                           class="btn btn-sm"
                           style="background-color: #cfe2f3; color: #495057; border-radius: 6px;">
                            <i class="bi bi-eye"></i> Ver
                        </a>

                        <a asp-action="Delete" asp-route-id="@item.Id"
                           class="btn btn-sm"
                           style="background-color: #e57373; color: white; border-radius: 6px;">
                            <i class="bi bi-trash"></i> Eliminar
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Paginación -->
    <partial name="_Paginacion" model="ViewBag.Paginacion" />
</div>
@section Scripts {
    <script>
        (function () {
            const input = document.querySelector('input[name="buscar"]');
            const tbody = document.querySelector('table tbody');
            let timer = null;
            let lastTerm = input ? (input.value || '').trim() : '';

            function debounce(fn, delay) {
                return function (...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn.apply(this, args), delay);
                };
            }

            async function buscar(term) {
                try {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner-border" role="status" aria-label="Cargando resultados"></div>
                            </td>
                        </tr>`;

                    const url = '@Url.Action("Buscar", "Pedidos")' + '?term=' + encodeURIComponent(term || '');
                    const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    if (!resp.ok) throw new Error('Error al cargar resultados');
                    const html = await resp.text();
                    tbody.innerHTML = html;
                } catch (e) {
                    console.error(e);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger">Ocurrió un error al buscar.</td>
                        </tr>`;
                }
            }

            const onInput = debounce((ev) => {
                const term = (ev.target.value || '').trim();
                if (term === lastTerm) return;
                lastTerm = term;
                buscar(term);
            }, 300);

            if (input) {
                input.addEventListener('input', onInput);
            }
        })();
    </script>
}
